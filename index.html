import React, { useEffect, useState } from 'react';
import './App.css';

export default function App() {
  const todayKey = () => new Date().toISOString().slice(0, 10);

  const sampleLines = [
    { text: 'We either die a hero or live long enough to see ourselves become the villain.', source: 'The Dark Knight', tone: 'regret' },
    { text: 'I wish I knew how to quit you.', source: 'Brokeback Mountain', tone: 'hurt' },
    { text: 'After all this time', source: 'Harry Potter', tone: 'nostalgia' },
    { text: 'I have to believe in a world outside my own mind.', source: 'A Beautiful Mind', tone: 'hope' },
    { text: 'You have to do your own growing, no matter how tall your father was.', source: 'The Tree of Life', tone: 'painful' },
    { text: 'Sometimes the things that may or may not be true are the things a man needs to believe in the most.', source: 'Big Fish', tone: 'inspiring' }
  ];

  const [date, setDate] = useState(todayKey());
  const [currentEvent, setCurrentEvent] = useState('no current event shown');
  const [quote, setQuote] = useState(null);
  const [history, setHistory] = useState([]);
  const [inputTopic, setInputTopic] = useState('');

  useEffect(() => {
    const storedHistory = JSON.parse(localStorage.getItem('quoteHistory') || '[]');
    setHistory(storedHistory);
    const storedToday = localStorage.getItem('lockedQuote-' + date);
    if (storedToday) {
      setQuote(JSON.parse(storedToday));
    } else {
      generateQuoteAuto();
    }
    const timer = setInterval(() => {
      const nowKey = todayKey();
      if (nowKey !== date) {
        setDate(nowKey);
        localStorage.removeItem('lockedQuote-' + date);
        generateQuoteAuto(nowKey);
      }
    }, 60000);
    return () => clearInterval(timer);
  }, []);

  const saveHistory = (q) => {
    const next = [{ ...q, date }, ...history];
    setHistory(next);
    localStorage.setItem('quoteHistory', JSON.stringify(next));
  };

  const pickLineForKeyword = (keyword) => {
    if (!keyword) return sampleLines[Math.floor(Math.random() * sampleLines.length)];
    const lower = keyword.toLowerCase();
    const pool = sampleLines.filter(s => s.text.toLowerCase().includes(lower) || s.source.toLowerCase().includes(lower) || (s.tone && s.tone.includes(lower)));
    if (pool.length) return pool[Math.floor(Math.random() * pool.length)];
    return sampleLines[Math.floor(Math.random() * sampleLines.length)];
  };

  const generateQuoteAuto = () => {
    setCurrentEvent('no current event shown');
    const q = pickLineForKeyword(inputTopic);
    setQuote(q);
    localStorage.setItem('lockedQuote-' + date, JSON.stringify(q));
    saveHistory(q);
  };

  const onGenerate = () => {
    const q = pickLineForKeyword(inputTopic);
    setQuote(q);
    saveHistory(q);
  };

  return (
    <div className="app">
      <header className="header">
        <div>{date}</div>
        <div>{currentEvent}</div>
      </header>
      <main>
        <section className="quote-section">
          <h2>Quote of the Day</h2>
          <p>{quote ? `"${quote.text}"` : 'No quote generated yet'}</p>
          <small>{quote ? `source: ${quote.source}` : ''}</small>
          <div className="controls">
            <button onClick={onGenerate}>Generate</button>
            <input value={inputTopic} onChange={e => setInputTopic(e.target.value)} placeholder="Optional topic" />
          </div>
        </section>
        <section className="history">
          <h3>History</h3>
          {history.length ? history.map((h, i) => (
            <div key={i}>
              <em>"{h.text}"</em> - {h.source} ({h.date})
            </div>
          )) : <p>No history yet</p>}
        </section>
      </main>
    </div>
  );
}
